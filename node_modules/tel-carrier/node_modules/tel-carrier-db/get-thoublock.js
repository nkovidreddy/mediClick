'use strict';

var fs = require('fs')
  , data = require('./data')
  , meta = require('./meta')
  , scrape = require('./thoublock-scrape').scrape
  , forAllAsync = require('forallasync').forAllAsync
  , forEachAsync = require('foreachasync').forEachAsync
  , request = require('request')
  , areaCodes = {}
  , blocks = ['0000', '1000', '2000', '3000', '4000', '5000', '6000', '7000', '8000', '9000']
  ;

function getBlock(areaCode, prefix, block, fn) {
  var url
    ;

  //console.log(prefixes.length);
  url = 'http://www.fonefinder.net/findome.php'
    + '?npa=' + areaCode
    + '&nxx=' + prefix
    + '&thoublock=' + block
    + '&usaquerytype=Search+by+Number&cityname='
    ;

  console.log(url);
  request.get(
    url
  , function (err, req, data) {
      var info = scrape(data);
      fn(info);
    }
  );
}

forEachAsync(Object.keys(data.list).slice(99, 101), function (next, areaCode) {
  var areaCodePath = './data/thoublocks/' + areaCode + '.json'
    , prefixes = data.list[areaCode]
    , count = 0
    ;

  if (fs.existsSync(areaCodePath)) {
    // read in file
    areaCodes[areaCode] = require(areaCodePath);
  } else {
    areaCodes[areaCode] = {};
  }

  forEachAsync(prefixes, function (nex, prefixArr) {
    var blockMap = []
      , prefix = prefixArr[0]
      ;

    if (areaCodes[areaCode][prefix]) {
      nex();
      return;
    }

    forEachAsync(blocks, function (n, block) {
      getBlock(areaCode, prefix, block, function (map) {
        /* TODO map map with meta */
        blockMap[block / 1000] = { block: block, info: map[0] };
        n();
      });
    }).then(function () {
      areaCodes[areaCode][prefix] = blockMap;
      // save every 1000 requests (about each 1/10 of the whole file)
      count += 1;
      if (count > 100) {
        fs.writeFileSync(areaCodePath, JSON.stringify(areaCodes[areaCode], null, '  '));
        count = 0;
      }
      nex();
    });
  }).then(function () {
    // write to file for each of 1000 area codes that each contain 1000 * 10 prefixes
    fs.writeFileSync(areaCodePath, JSON.stringify(areaCodes[areaCode], null, '  '));
  });
}).then(function () {
  // write to file when all area codes are complete
  console.log('all area codes complete!');
});
